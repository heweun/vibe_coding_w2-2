name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Auto code review
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          
          // ë³€ê²½ëœ íŒŒì¼ë“¤ ê°€ì ¸ì˜¤ê¸°
          const files = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: number
          });
          
          const reviews = [];
          
          for (const file of files.data) {
            const filename = file.filename;
            const patch = file.patch || '';
            
            // Python íŒŒì¼ ì²´í¬
            if (filename.endsWith('.py')) {
              const lines = patch.split('\n');
              let lineNumber = 0;
              
              for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.startsWith('@@')) {
                  const match = line.match(/@@ -\d+(?:,\d+)? \+(\d+)(?:,\d+)? @@/);
                  if (match) {
                    lineNumber = parseInt(match[1]) - 1;
                  }
                  continue;
                }
                
                if (line.startsWith('+')) {
                  lineNumber++;
                  const code = line.substring(1);
                  
                  // ì½”ë“œ ìŠ¤íƒ€ì¼ ì²´í¬
                  if (code.includes('print(') && !filename.includes('test_')) {
                    reviews.push({
                      path: filename,
                      line: lineNumber,
                      body: 'ğŸ” **ì½”ë“œ ë¦¬ë·°**: print() ë¬¸ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. í”„ë¡œë•ì…˜ ì½”ë“œì—ì„œëŠ” loggingì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.'
                    });
                  }
                  
                  if (code.length > 100) {
                    reviews.push({
                      path: filename,
                      line: lineNumber,
                      body: 'ğŸ“ **ì½”ë“œ ë¦¬ë·°**: ë¼ì¸ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (100ì ì´ˆê³¼). ê°€ë…ì„±ì„ ìœ„í•´ ì¤„ë°”ê¿ˆì„ ê³ ë ¤í•´ë³´ì„¸ìš”.'
                    });
                  }
                  
                  if (code.includes('TODO') || code.includes('FIXME')) {
                    reviews.push({
                      path: filename,
                      line: lineNumber,
                      body: 'ğŸ“ **ì½”ë“œ ë¦¬ë·°**: TODO/FIXME ì£¼ì„ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¡œ ë“±ë¡í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.'
                    });
                  }
                  
                  // ë³´ì•ˆ ê´€ë ¨ ì²´í¬
                  if (code.includes('password') || code.includes('secret') || code.includes('token')) {
                    reviews.push({
                      path: filename,
                      line: lineNumber,
                      body: 'ğŸ”’ **ë³´ì•ˆ ë¦¬ë·°**: ë¯¼ê°í•œ ì •ë³´ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ìˆì§€ ì•Šì€ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'
                    });
                  }
                } else if (!line.startsWith('-')) {
                  lineNumber++;
                }
              }
            }
          }
          
          // ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ìˆìœ¼ë©´ ë¦¬ë·° ìƒì„±
          if (reviews.length > 0) {
            try {
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number: number,
                body: `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·°
                
ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ì ì¸ ì½”ë“œ ìŠ¤íƒ€ì¼ê³¼ ë³´ì•ˆ ì‚¬í•­ì„ ì²´í¬í•©ë‹ˆë‹¤.

**ë¦¬ë·°ëœ í•­ëª©:**
- ì½”ë“œ ìŠ¤íƒ€ì¼ (ë¼ì¸ ê¸¸ì´, print ë¬¸ ì‚¬ìš©)
- ë³´ì•ˆ (í•˜ë“œì½”ë”©ëœ ë¯¼ê°ì •ë³´)
- TODO/FIXME ì£¼ì„

ë” ìì„¸í•œ ë¦¬ë·°ëŠ” íŒ€ ë©¤ë²„ê°€ ì§„í–‰í•´ì£¼ì„¸ìš”! ğŸ‘¥`,
                event: 'COMMENT',
                comments: reviews.slice(0, 10) // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ
              });
              
              console.log(`ìë™ ì½”ë“œ ë¦¬ë·° ì™„ë£Œ: ${reviews.length}ê°œ í•­ëª© ì²´í¬ë¨`);
            } catch (error) {
              console.log('ìë™ ì½”ë“œ ë¦¬ë·° ì‹¤íŒ¨:', error.message);
            }
          } 